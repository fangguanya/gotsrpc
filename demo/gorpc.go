// this file was auto generated by gotsrpc https://github.com/foomo/gotsrpc
package demo

import (
	tls "crypto/tls"
	gob "encoding/gob"
	fmt "fmt"
	gotsrpc "github.com/foomo/gotsrpc"
	nested "github.com/foomo/gotsrpc/demo/nested"
	gorpc "github.com/valyala/gorpc"
	reflect "reflect"
	strings "strings"
	time "time"
)

type (
	FooGoRPCProxy struct {
		server           *gorpc.Server
		service          *Foo
		callStatsHandler gotsrpc.GoRPCCallStatsHandlerFun
	}

	HelloRequest struct {
		Number int64
	}
	HelloResponse struct {
		RetHello_0 int
	}
)

func init() {
	gob.Register(HelloRequest{})
	gob.Register(HelloResponse{})
}

func NewFooGoRPCProxy(addr string, service *Foo, tlsConfig *tls.Config) *FooGoRPCProxy {
	proxy := &FooGoRPCProxy{
		service: service,
	}

	if tlsConfig != nil {
		proxy.server = gorpc.NewTLSServer(addr, proxy.handler, tlsConfig)
	} else {
		proxy.server = gorpc.NewTCPServer(addr, proxy.handler)
	}

	return proxy
}

func (p *FooGoRPCProxy) Start() error {
	return p.server.Start()
}

func (p *FooGoRPCProxy) Stop() {
	p.server.Stop()
}

func (p *FooGoRPCProxy) SetCallStatsHandler(handler gotsrpc.GoRPCCallStatsHandlerFun) {
	p.callStatsHandler = handler
}

func (p *FooGoRPCProxy) handler(clientAddr string, request interface{}) (response interface{}) {
	start := time.Now()

	reqType := reflect.TypeOf(request).String()
	funcNameParts := strings.Split(reqType, ".")
	funcName := funcNameParts[len(funcNameParts)-1]

	switch funcName {
	case "HelloRequest":
		req := request.(HelloRequest)
		retHello_0 := p.service.Hello(req.Number)
		response = HelloResponse{RetHello_0: retHello_0}
	default:
		fmt.Println("Unkown request type", reflect.TypeOf(request).String())
	}

	if p.callStatsHandler != nil {
		p.callStatsHandler(&gotsrpc.CallStats{
			Func:      funcName,
			Package:   "github.com/foomo/gotsrpc/demo",
			Service:   "Foo",
			Execution: time.Since(start),
		})
	}

	return
}

type (
	DemoGoRPCProxy struct {
		server           *gorpc.Server
		service          *Demo
		callStatsHandler gotsrpc.GoRPCCallStatsHandlerFun
	}

	ExtractAddressRequest struct {
		Person *Person
	}
	ExtractAddressResponse struct {
		Addr *Address
		E    *Err
	}

	GiveMeAScalarRequest struct {
	}
	GiveMeAScalarResponse struct {
		Amount nested.Amount
		Wahr   nested.True
		Hier   ScalarInPlace
	}

	HelloRequest struct {
		Name string
	}
	HelloResponse struct {
		Reply string
		Err   *Err
	}

	MapCrapRequest struct {
	}
	MapCrapResponse struct {
		Crap map[string][]int
	}

	NestRequest struct {
	}
	NestResponse struct {
		RetNest_0 *nested.Nested
	}

	TestScalarInPlaceRequest struct {
	}
	TestScalarInPlaceResponse struct {
		RetTestScalarInPlace_0 ScalarInPlace
	}
)

func init() {
	gob.Register(ExtractAddressRequest{})
	gob.Register(ExtractAddressResponse{})
	gob.Register(GiveMeAScalarRequest{})
	gob.Register(GiveMeAScalarResponse{})
	gob.Register(HelloRequest{})
	gob.Register(HelloResponse{})
	gob.Register(MapCrapRequest{})
	gob.Register(MapCrapResponse{})
	gob.Register(NestRequest{})
	gob.Register(NestResponse{})
	gob.Register(TestScalarInPlaceRequest{})
	gob.Register(TestScalarInPlaceResponse{})
}

func NewDemoGoRPCProxy(addr string, service *Demo, tlsConfig *tls.Config) *DemoGoRPCProxy {
	proxy := &DemoGoRPCProxy{
		service: service,
	}

	if tlsConfig != nil {
		proxy.server = gorpc.NewTLSServer(addr, proxy.handler, tlsConfig)
	} else {
		proxy.server = gorpc.NewTCPServer(addr, proxy.handler)
	}

	return proxy
}

func (p *DemoGoRPCProxy) Start() error {
	return p.server.Start()
}

func (p *DemoGoRPCProxy) Stop() {
	p.server.Stop()
}

func (p *DemoGoRPCProxy) SetCallStatsHandler(handler gotsrpc.GoRPCCallStatsHandlerFun) {
	p.callStatsHandler = handler
}

func (p *DemoGoRPCProxy) handler(clientAddr string, request interface{}) (response interface{}) {
	start := time.Now()

	reqType := reflect.TypeOf(request).String()
	funcNameParts := strings.Split(reqType, ".")
	funcName := funcNameParts[len(funcNameParts)-1]

	switch funcName {
	case "ExtractAddressRequest":
		req := request.(ExtractAddressRequest)
		addr, e := p.service.ExtractAddress(req.Person)
		response = ExtractAddressResponse{Addr: addr, E: e}
	case "GiveMeAScalarRequest":
		amount, wahr, hier := p.service.GiveMeAScalar()
		response = GiveMeAScalarResponse{Amount: amount, Wahr: wahr, Hier: hier}
	case "HelloRequest":
		req := request.(HelloRequest)
		reply, err := p.service.Hello(req.Name)
		response = HelloResponse{Reply: reply, Err: err}
	case "MapCrapRequest":
		crap := p.service.MapCrap()
		response = MapCrapResponse{Crap: crap}
	case "NestRequest":
		retNest_0 := p.service.Nest()
		response = NestResponse{RetNest_0: retNest_0}
	case "TestScalarInPlaceRequest":
		retTestScalarInPlace_0 := p.service.TestScalarInPlace()
		response = TestScalarInPlaceResponse{RetTestScalarInPlace_0: retTestScalarInPlace_0}
	default:
		fmt.Println("Unkown request type", reflect.TypeOf(request).String())
	}

	if p.callStatsHandler != nil {
		p.callStatsHandler(&gotsrpc.CallStats{
			Func:      funcName,
			Package:   "github.com/foomo/gotsrpc/demo",
			Service:   "Demo",
			Execution: time.Since(start),
		})
	}

	return
}
